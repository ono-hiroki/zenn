---
title: "Kubernetes Ingresså…¥é–€ - 1ã¤ã®å…¥å£ã§è¤‡æ•°Serviceã«HTTPãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°"
emoji: "ğŸšª"
type: "tech"
topics: ["kubernetes", "ingress", "nginx", "kind"]
published: false
---

## ã¯ã˜ã‚ã«

Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã§ Web ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€Service ã®å„ã‚¿ã‚¤ãƒ—ï¼ˆClusterIPã€NodePortã€LoadBalancerï¼‰ãŒã‚ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ãã‚Œã‚‰ã®å¾©ç¿’ã‚’ã—ãªãŒã‚‰ã€ã‚ˆã‚Šå®Ÿè·µçš„ãªå¤–éƒ¨å…¬é–‹ã®æ–¹æ³•ã§ã‚ã‚‹ **Ingress** ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

:::message
æœ¬è¨˜äº‹ã§ã¯ `kubectl` ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ `k` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
:::

## Service ã®å¾©ç¿’ï¼šå¤–éƒ¨å…¬é–‹ã®èª²é¡Œ

### Service ã‚¿ã‚¤ãƒ—ã®ãŠã•ã‚‰ã„

| ã‚¿ã‚¤ãƒ— | ã‚¢ã‚¯ã‚»ã‚¹ç¯„å›² | ç”¨é€” |
|--------|-------------|------|
| **ClusterIP** | ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã®ã¿ | å†…éƒ¨é€šä¿¡ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ |
| **NodePort** | Node ã® IP + ãƒãƒ¼ãƒˆ | é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ |
| **LoadBalancer** | å¤–éƒ¨ LB çµŒç”± | æœ¬ç•ªç’°å¢ƒã§ã®å¤–éƒ¨å…¬é–‹ |

### ClusterIP ã®å¾©ç¿’

ClusterIP ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª Service ã§ã™ã€‚

```yaml
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
```

```
ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å¤– â†’ ClusterIP:80 â†’ âœ— ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†… â†’ ClusterIP:80 â†’ â—‹ Pod ã«åˆ°é”
```

**ClusterIP ã ã‘ã§ã¯å¤–éƒ¨å…¬é–‹ã§ãã¾ã›ã‚“ã€‚**

### NodePort ã®å¾©ç¿’

NodePort ã¯å…¨ã¦ã® Node ã§åŒã˜ãƒãƒ¼ãƒˆï¼ˆ30000-32767ï¼‰ã‚’é–‹ãã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™ã€‚

```yaml
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30000
```

```
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ Node1:30000 â”€â”¬â†’ Pod A
              Node2:30000 â”€â”¤â†’ Pod B
              Node3:30000 â”€â”˜â†’ Pod C
```

**NodePort ã®èª²é¡Œ:**

- ã©ã® Node ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¬¡ç¬¬
- Node ãŒéšœå®³ã§è½ã¡ãŸã‚‰ã€ãã® Node çµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å¤±æ•—
- 30000-32767 ã®ç¯„å›²ã—ã‹ä½¿ãˆãªã„ï¼ˆ80 ã‚„ 443 ã¯ä½¿ãˆãªã„ï¼‰

### LoadBalancer ã®å¾©ç¿’

LoadBalancer ã¯ NodePort + å¤–éƒ¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚

```yaml
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 80
```

```
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ å¤–éƒ¨LB â†’ Node:NodePort â†’ Pod
```

**LoadBalancer ã®èª²é¡Œ:**

```
Service A (type: LoadBalancer) â†’ LB A â†’ èª²é‡‘
Service B (type: LoadBalancer) â†’ LB B â†’ èª²é‡‘
Service C (type: LoadBalancer) â†’ LB C â†’ èª²é‡‘

3 ã¤ã® Service = 3 ã¤ã® LB = 3 å€ã®ã‚³ã‚¹ãƒˆ
```

- **1 Service ã«ã¤ã 1 ã¤ã® LB** ãŒä½œæˆã•ã‚Œã‚‹
- Service ãŒå¢—ãˆã‚‹ã¨ã‚³ã‚¹ãƒˆãŒå¢—åŠ 
- ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒã§ããªã„ï¼ˆ`/api` â†’ Service Aã€`/web` â†’ Service B ãªã©ï¼‰

## Ingress ã¨ã¯

Ingress ã¯ **1 ã¤ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§è¤‡æ•°ã® Service ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**ã§ãã‚‹ä»•çµ„ã¿ã§ã™ã€‚

### LoadBalancer vs Ingress

```
LoadBalancerï¼ˆService ã”ã¨ã« LBï¼‰:

  /api  â†’ LB A â†’ Service A â†’ èª²é‡‘
  /web  â†’ LB B â†’ Service B â†’ èª²é‡‘
  /admin â†’ LB C â†’ Service C â†’ èª²é‡‘

Ingressï¼ˆ1 ã¤ã®å…¥å£ã§æŒ¯ã‚Šåˆ†ã‘ï¼‰:

              â”Œâ†’ /api   â†’ Service A
  Client â†’ Ingress â”€â”¼â†’ /web   â†’ Service B  â†’ èª²é‡‘ï¼ˆ1ã¤åˆ†ï¼‰
              â””â†’ /admin â†’ Service C
```

### L4 ã¨ L7 ã®é•ã„

Service ã¨ Ingress ã®å¤§ããªé•ã„ã¯ã€**ã©ã®æƒ…å ±ã‚’è¦‹ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã‹**ã§ã™ã€‚

```
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ã‚¤ãƒ¤ãƒ¼:

  L7 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤  â† HTTP ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒ‘ã‚¹ã€ãƒ›ã‚¹ãƒˆå
  L4 ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤    â† TCP/UDPã€IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç•ªå·
```

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | è¦‹ã‚‹æƒ…å ± | ä¾‹ |
|---------|----------|-----|
| **L4** | IP + ãƒãƒ¼ãƒˆç•ªå· | `10.0.0.1:80` â†’ Service A |
| **L7** | HTTP ã®ä¸­èº«ï¼ˆãƒ‘ã‚¹ã€ãƒ›ã‚¹ãƒˆåï¼‰ | `GET /api` â†’ Service Aã€`GET /web` â†’ Service B |

**Serviceï¼ˆkube-proxyï¼‰ã®å‹•ä½œï¼ˆL4ï¼‰:**

```
ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 10.96.0.1:80
              â†“
kube-proxy: ã€Œ80ç•ªãƒãƒ¼ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ãªã€
              â†“
           Pod A, B, C ã®ã©ã‚Œã‹ã¸ï¼ˆHTTP ã®ä¸­èº«ã¯è¦‹ãªã„ï¼‰
```

**Ingress Controller ã®å‹•ä½œï¼ˆL7ï¼‰:**

```
ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: GET /api HTTP/1.1
           Host: example.com
              â†“
Ingress Controller: ã€Œ/api ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ãªã€‚api-service ã«é€ã‚ã†ã€
              â†“
           api-service ã¸
```

### Ingress ã®ç‰¹å¾´

| é …ç›® | Service | Ingress |
|------|---------|---------|
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ | IP + Portï¼ˆL4ï¼‰ | Host + Pathï¼ˆL7 / HTTPï¼‰ |
| LB ã®æ•° | Service ã”ã¨ã« 1 ã¤ | å…¨ä½“ã§ 1 ã¤ |
| ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ | âœ— | â—‹ `/api`, `/web` ãªã© |
| ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ | âœ— | â—‹ `api.example.com`, `web.example.com` ãªã© |
| SSL çµ‚ç«¯ | Service ã”ã¨ã«è¨­å®š | Ingress ã§ä¸€å…ƒç®¡ç† |

```
L4ï¼ˆServiceï¼‰:
  10.0.0.1:80 â”€â”€â†’ Service A
  10.0.0.1:8080 â”€â”€â†’ Service B
  â€» åŒã˜ãƒãƒ¼ãƒˆã§è¤‡æ•° Service ã«ã¯æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œãªã„

L7ï¼ˆIngressï¼‰:
  example.com:80/api â”€â”€â†’ Service A â”
  example.com:80/web â”€â”€â†’ Service B â”œ åŒã˜ãƒãƒ¼ãƒˆ(80)ã§æŒ¯ã‚Šåˆ†ã‘å¯èƒ½
  example.com:80/admin â”€â”€â†’ Service C â”˜
```

### Ingress ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æµã‚Œ

```mermaid
flowchart TB
    Client[Client]

    subgraph Cluster[Kubernetes Cluster]
        IngressSvc[LoadBalancer / NodePort Service<br/>Ingress Controller ç”¨]

        subgraph IngressController[Ingress Controller Pod]
            Nginx[nginx ç­‰ãŒå‹•ã„ã¦ã„ã‚‹<br/>Ingress ãƒªã‚½ãƒ¼ã‚¹ã‚’ watch]
        end

        ClusterIPSvc[ClusterIP Service<br/>ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã®ã¿]

        Pod[Pod]
    end

    Client --> IngressSvc
    IngressSvc --> IngressController
    IngressController -->|Ingress ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æŒ¯ã‚Šåˆ†ã‘| ClusterIPSvc
    ClusterIPSvc --> Pod
```

**æ§‹æˆè¦ç´ :**

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | èª¬æ˜ |
|---------------|------|
| **LoadBalancer / NodePort Service** | Ingress Controller ã‚’å¤–éƒ¨å…¬é–‹ã™ã‚‹ãŸã‚ã® Service |
| **Ingress Controller Pod** | nginx ç­‰ãŒå‹•ã„ã¦ã„ã‚‹ã€‚Ingress ãƒªã‚½ãƒ¼ã‚¹ã‚’ watch ã—ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| **ClusterIP Service** | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® Serviceï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã®ã¿ï¼‰ |
| **Pod** | å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |

:::message
Ingress Controller ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã«ã„ã‚‹ãŸã‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® Service ã¯ ClusterIP ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚
:::

### ãªãœ Ingress Controller ã‚’çµŒç”±ã™ã‚‹ã®ã‹

ã€Œå¤–éƒ¨ LB ã‹ã‚‰ ClusterIP ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã„ã„ã®ã§ã¯ï¼Ÿã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã‚Œã¯ã§ãã¾ã›ã‚“ã€‚

**ClusterIP ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨å°‚ç”¨ã®ä»®æƒ³ IP** ã ã‹ã‚‰ã§ã™ã€‚

```
ClusterIP ã®ä»•çµ„ã¿:

  ClusterIP: 10.96.0.100ï¼ˆä»®æƒ³ IPï¼‰
       â†“
  Node å†…ã® iptables ãŒãƒ‘ã‚±ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ
       â†“
  å®›å…ˆã‚’ Pod ã®å®Ÿ IP ã«æ›¸ãæ›ãˆ
       â†“
  Pod ã«åˆ°é”

ã“ã® iptables ãƒ«ãƒ¼ãƒ«ã¯ Node å†…ã«ã—ã‹å­˜åœ¨ã—ãªã„
â†’ å¤–éƒ¨ã‹ã‚‰ã¯ ClusterIP ã«åˆ°é”ã§ããªã„
```

```
å¤–éƒ¨ LB ã‹ã‚‰è¦‹ãŸå ´åˆ:

  å¤–éƒ¨ LB ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«:
    10.0.0.0/16   â†’ åˆ°é”å¯èƒ½ï¼ˆç‰©ç†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
    10.96.0.0/16  â†’ ??? çŸ¥ã‚‰ãªã„ï¼ˆClusterIP ã®ç¯„å›²ï¼‰

  â†’ å¤–éƒ¨ LB ã¯ ClusterIP ã¸ã®ãƒ«ãƒ¼ãƒˆã‚’æŒã£ã¦ã„ãªã„
```

**ã ã‹ã‚‰ Ingress Controller ãŒå¿…è¦:**

```
å¤–éƒ¨ LB â†’ Ingress Controller Pod â†’ ClusterIP â†’ Pod
          â†‘                        â†‘
          ã“ã“ã§å¤–éƒ¨â†’å†…éƒ¨ã®å¢ƒç•Œ    ã“ã“ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨

Ingress Controller Pod ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…éƒ¨ã«ã„ã‚‹ã®ã§
ClusterIP ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
```

## ç’°å¢ƒæ§‹ç¯‰

### kind ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä½œæˆ

kind ã§ Ingress ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆæ™‚ã«ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

`kind-config.yaml`:

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  kubeadmConfigPatches:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        node-labels: "ingress-ready=true"
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
```

**è¨­å®šã®èª¬æ˜:**

| é …ç›® | èª¬æ˜ |
|------|------|
| `ingress-ready=true` | Ingress Controller ãŒã“ã®ãƒãƒ¼ãƒ‰ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã‚‹ãŸã‚ã®ãƒ©ãƒ™ãƒ« |
| `extraPortMappings` | ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆ80, 443ï¼‰ |

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
kind create cluster --config kind-config.yaml
```

æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆã—ã¾ã™ã€‚

```bash
kind delete cluster && kind create cluster --config kind-config.yaml
```

### Docker ã®ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç¢ºèª

kind ã¯ Kubernetes ã® Node ã‚’ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

`extraPortMappings` ã¯ **Docker ã® `-p` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨åŒã˜**ã§ã™ã€‚

```
extraPortMappings:
  - containerPort: 80
    hostPort: 80

ã“ã‚Œã¯ä»¥ä¸‹ã¨åŒã˜:
  docker run -p 80:80 kindest/node
```

`extraPortMappings` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash
docker ps --format "table {{.Names}}\t{{.Ports}}"
```

```
NAMES                 PORTS
kind-control-plane    0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 127.0.0.1:xxxxx->6443/tcp
```

`0.0.0.0:80->80/tcp` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ›ã‚¹ãƒˆã® 80 ç•ªãƒãƒ¼ãƒˆãŒ Node ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

### NGINX Ingress Controller ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

kind å°‚ç”¨ã® manifest ã‚’ä½¿ç”¨ã—ã¦ Ingress Controller ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
k apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.0/deploy/static/provider/kind/deploy.yaml
```

Ingress Controller ã® Pod ãŒ Ready ã«ãªã‚‹ã¾ã§å¾…ã¡ã¾ã™ã€‚

```bash
k wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=120s
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```bash
k get all -n ingress-nginx
```

```
NAME                                            READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-xxxxx        0/1     Completed   0          60s
pod/ingress-nginx-admission-patch-xxxxx         0/1     Completed   0          60s
pod/ingress-nginx-controller-xxxxxxxxx-xxxxx    1/1     Running     0          60s

NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
service/ingress-nginx-controller             NodePort    10.96.xxx.xxx   <none>        80:80/TCP,443:443/TCP        60s
service/ingress-nginx-controller-admission   ClusterIP   10.96.xxx.xxx   <none>        443/TCP                      60s
```

**æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆ:**

- Ingress Controller è‡ªä½“ãŒ **NodePort Service** ã¨ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹
- `extraPortMappings` ã«ã‚ˆã‚Šã€ãƒ›ã‚¹ãƒˆã® 80/443 ãŒã“ã® NodePort ã«è»¢é€ã•ã‚Œã‚‹

```
localhost:80 â†’ (extraPortMappings) â†’ Node:80 â†’ Ingress Controller Pod
```

### Namespace ã‚’ç”¨æ„

```bash
k create namespace dev
```

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æº–å‚™

### ReplicaSet ã® manifest ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

`nginxserver-replicaset.yaml`:

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginxserver-replicaset
  namespace: dev
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginxserver
  template:
    metadata:
      labels:
        app: nginxserver
    spec:
      containers:
      - image: nginx:latest
        name: nginxserver
```

### Service ã® manifest ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

**Ingress ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ã† Service ã¯ ClusterIP ã§ååˆ†ã§ã™ã€‚**

`nginxserver-service.yaml`:

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginxserver-service
  name: nginxserver-service
  namespace: dev
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 80
  selector:
    app: nginxserver
  type: ClusterIP              # NodePort ã‚„ LoadBalancer ã«ã™ã‚‹å¿…è¦ãªã—
```

### ReplicaSet ã¨ Service ã‚’é©ç”¨

```bash
k apply -f nginxserver-replicaset.yaml
k apply -f nginxserver-service.yaml
```

Pod ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
k get pod -n dev
```

```
NAME                           READY   STATUS    RESTARTS   AGE
nginxserver-replicaset-cmnhx   1/1     Running   0          10s
nginxserver-replicaset-k52tk   1/1     Running   0          10s
nginxserver-replicaset-vs67s   1/1     Running   0          10s
```

Service ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
k get service -n dev
```

```
NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
nginxserver-service   ClusterIP   10.104.93.222   <none>        80/TCP    10s
```

:::message
ã“ã®æ™‚ç‚¹ã§ã¯ ClusterIP ãªã®ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å¤–ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚
:::

## å˜ä¸€ãƒ‘ã‚¹ã® Ingress

### Ingress ã® manifest ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

`nginxserver-ingress.yaml`:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginxserver-ingress      # ã“ã® Ingress ãƒªã‚½ãƒ¼ã‚¹ã®åå‰
  namespace: dev                 # Service ã¨åŒã˜ namespace ã«ä½œæˆ
spec:
  ingressClassName: nginx        # ã©ã® Ingress Controller ã‚’ä½¿ã†ã‹ï¼ˆnginx ã‚’æŒ‡å®šï¼‰
  rules:                         # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆ
    - http:                      # HTTP/HTTPS ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå›ºå®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åï¼‰
        paths:                   # ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
          - path: /              # ã“ã®ãƒ‘ã‚¹ã«ãƒãƒƒãƒã—ãŸã‚‰
            pathType: Exact      # å®Œå…¨ä¸€è‡´ï¼ˆ/ ã®ã¿ã€‚/foo ã¯å¯¾è±¡å¤–ï¼‰
            backend:             # ä»¥ä¸‹ã® Service ã«è»¢é€
              service:
                name: nginxserver-service  # â† Service ã® metadata.name ã¨ä¸€è‡´
                port:
                  name: http               # â† Service ã® spec.ports[].name ã¨ä¸€è‡´
```

**Service ã¨ã®å¯¾å¿œé–¢ä¿‚:**

| Ingress ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å€¤ | å¯¾å¿œã™ã‚‹ Service ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ |
|---------------------|-----|------------------------------|
| `backend.service.name` | `nginxserver-service` | `metadata.name` |
| `backend.service.port.name` | `http` | `spec.ports[].name` |

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|-----------|------|
| `ingressClassName` | ä½¿ç”¨ã™ã‚‹ Ingress Controller ã®ã‚¯ãƒ©ã‚¹åï¼ˆnginxï¼‰ |
| `rules[].http.paths[]` | HTTP ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ« |
| `backend.service` | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å…ˆã® Serviceï¼ˆClusterIPï¼‰ |
| `path` | ãƒãƒƒãƒã™ã‚‹ãƒ‘ã‚¹ |
| `pathType` | ãƒ‘ã‚¹ã®ãƒãƒƒãƒæ–¹å¼ï¼ˆExact / Prefixï¼‰ |

### Ingress ã‚’é©ç”¨

```bash
k apply -f nginxserver-ingress.yaml
```

Ingress ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
k get ingress -n dev
```

```
NAME                  CLASS   HOSTS   ADDRESS   PORTS   AGE
nginxserver-ingress   nginx   *                 80      5s
```

### å‹•ä½œç¢ºèª

kind ã§ã¯ `extraPortMappings` ã«ã‚ˆã‚Šãƒ›ã‚¹ãƒˆã® 80 ç•ªãƒãƒ¼ãƒˆãŒã‚³ãƒ³ãƒ†ãƒŠã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€`localhost` ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```bash
curl --head http://localhost:80
```

```
HTTP/1.1 200 OK
Date: Wed, 14 Aug 2024 03:37:21 GMT
Content-Type: text/html
Content-Length: 615
Connection: keep-alive
Last-Modified: Tue, 28 May 2024 13:22:30 GMT
ETag: "6655da96-267"
Accept-Ranges: bytes
```

**ClusterIP ã® Service ã«å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼**

### ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æµã‚Œã‚’ç¢ºèª

```
curl http://localhost:80
        â”‚
        â–¼ extraPortMappings (hostPort:80 â†’ containerPort:80)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  kind Node                        â”‚
â”‚    â””â”€ :80                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ NodePort Service
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controller Pod           â”‚
â”‚  (ingress-nginx-controller)       â”‚
â”‚                                   â”‚
â”‚  Ingress ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª:            â”‚
â”‚  ã€Œ/ â†’ nginxserver-service:httpã€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ ClusterIP Service
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nginxserver-service              â”‚
â”‚  (ClusterIP: 10.104.93.222)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ kube-proxy ã«ã‚ˆã‚‹è² è·åˆ†æ•£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nginxserver Pod (3å°)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NGINX Ingress Controller ã®è¨­å®šã‚’ç¢ºèª

Ingress Controllerï¼ˆnginxï¼‰ãŒ L7 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã©ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

#### nginx.conf ã‚’ç¢ºèª

Ingress Controller Pod ã®ä¸­ã«å…¥ã£ã¦ nginx.conf ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
# Ingress Controller Pod åã‚’å–å¾—
INGRESS_POD=$(k get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o jsonpath='{.items[0].metadata.name}')

# ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã‚‹
k exec -it -n ingress-nginx $INGRESS_POD -- /bin/bash

# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
cat /etc/nginx/nginx.conf | grep -B 5 -A 20 "nginxserver-service"
```

```nginx
                location = / {

                        set $namespace      "dev";
                        set $ingress_name   "nginxserver-ingress";
                        set $service_name   "nginxserver-service";
                        set $service_port   "http";
                        set $location_path  "/";
                        ...
```

ç¢ºèªãŒçµ‚ã‚ã£ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰æŠœã‘ã¾ã™ã€‚

```bash
exit
```

#### upstreamï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ Pod ã® IP ãƒªã‚¹ãƒˆï¼‰ã‚’ç¢ºèª

Ingress Controller ã®å†…éƒ¨ API ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® Pod IP ã‚’ç¢ºèªã—ã¾ã™ã€‚

:::message
`localhost:10246` ã¯ NGINX Ingress Controller ãŒæä¾›ã™ã‚‹å†…éƒ¨ API ã§ã™ã€‚nginx è‡ªä½“ã®æ©Ÿèƒ½ã§ã¯ãªãã€Controllerï¼ˆGo è£½ï¼‰ãŒè¿½åŠ ã§æä¾›ã—ã¦ã„ã¾ã™ã€‚
:::

```bash
k exec -n ingress-nginx $INGRESS_POD -- curl -s localhost:10246/configuration/backends | jq '.[] | select(.name | contains("nginxserver")) | {name, endpoints}'
```

```json
{
  "name": "dev-nginxserver-service-http",
  "endpoints": [
    { "address": "10.244.0.5", "port": "80" },
    { "address": "10.244.0.6", "port": "80" },
    { "address": "10.244.0.7", "port": "80" }
  ]
}
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**

- `name` ãŒ `dev-nginxserver-service-http`ï¼ˆnamespace-service-port å½¢å¼ï¼‰
- `endpoints` ã« 3 ã¤ã® Pod IP ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ï¼ˆReplicaSet ã§ 3 ã¤ä½œæˆã—ãŸãŸã‚ï¼‰
- nginx ãŒã“ã‚Œã‚‰ã® IP ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æ•£ã™ã‚‹

### å˜ä¸€ãƒ‘ã‚¹ã® Ingress ã‚’å‰Šé™¤

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ãƒ‘ã‚¹ã® Ingress ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ç¾åœ¨ã® Ingress ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```bash
k delete -f nginxserver-ingress.yaml
```

## pathType ã«ã¤ã„ã¦

Ingress ã«ã¯ãƒ‘ã‚¹ã®ãƒãƒƒãƒãƒ«ãƒ¼ãƒ«ã‚’ `pathType` ã§æŒ‡å®šã§ãã¾ã™ã€‚

### Prefix ã¨ Exact ã®æŒ™å‹•ã®é•ã„

ä¾‹: `path: /hoge` ã®è¨­å®šã«å¯¾ã™ã‚‹æŒ™å‹•

| ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒ‘ã‚¹ | Prefix | Exact | èª¬æ˜ |
|---------------------|--------|-------|------|
| `/hoge` | â—‹ | â—‹ | ã©ã¡ã‚‰ã‚‚å®Œå…¨ä¸€è‡´ã¨ã—ã¦å‡¦ç†ã™ã‚‹ |
| `/hoge/fuga` | â—‹ | Ã— | Prefix ã¯å‰æ–¹ä¸€è‡´ã€‚Exact ã¯å®Œå…¨ä¸€è‡´ã§ãªã„ãŸã‚ãƒãƒƒãƒã—ãªã„ |
| `/hogehoge` | Ã— | Ã— | ã©ã¡ã‚‰ã‚‚ /hoge ã«ä¸€è‡´ã—ãªã„ãŸã‚ã€ãƒãƒƒãƒã—ãªã„ |
| `/Hoge` | Ã— | Ã— | å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã€ä¸¡æ–¹ãƒãƒƒãƒã—ãªã„ |
| `/hoge/` | â—‹ | Ã— | Prefix ã¯å‰æ–¹ä¸€è‡´ã€‚Exact ã§ã¯ /hoge ã¨ /hoge/ ã¯åˆ¥ãƒ‘ã‚¹ |

### ImplementationSpecific

ä¸Šè¨˜ã® PathType ã®ä»–ã« `ImplementationSpecific` ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ Ingress Controller ã«ä»»ã›ã‚‹è¨­å®šã§ã™ã€‚

## è¤‡æ•°ãƒ‘ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

Ingress ã®å¼·ã¿ã¯ã€1 ã¤ã®å…¥å£ã§è¤‡æ•°ã® Service ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ãã‚‹ã“ã¨ã§ã™ã€‚

### æ§‹æˆä¾‹

```
Client
  â”‚
  â–¼
Ingress Controller
  â”œâ”€ /app  â†’ nginxserver-service â†’ nginx Pod
  â”œâ”€ /web  â†’ nginxserver-service â†’ nginx Pod
  â””â”€ /hoge â†’ âœ— ãƒãƒƒãƒã—ãªã„ï¼ˆIngress Controller ãŒ 404 ã‚’è¿”ã™ï¼‰
```

:::message
æœ¬æ¥ã¯ç•°ãªã‚‹ Service ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ãŒã€ã“ã“ã§ã¯æ—¢å­˜ã® `nginxserver-service` ã‚’ä½¿ã£ã¦è¤‡æ•°ãƒ‘ã‚¹ã®è¨­å®šæ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚
:::

### è¤‡æ•°ãƒ‘ã‚¹ã® Ingress manifest ã‚’ä½œæˆ

`multi-path-ingress.yaml`:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: multi-path-ingress
  namespace: dev
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          # /app ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          - path: /app
            pathType: Prefix                   # å‰æ–¹ä¸€è‡´ï¼ˆ/app, /app/xxxï¼‰
            backend:
              service:
                name: nginxserver-service      # â† Service ã® metadata.name
                port:
                  name: http                   # â† Service ã® spec.ports[].name
          # /web ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          - path: /web
            pathType: Prefix
            backend:
              service:
                name: nginxserver-service
                port:
                  name: http
```

**ãƒã‚¤ãƒ³ãƒˆ:**

| è¨­å®š | èª¬æ˜ |
|------|------|
| `paths` ã«è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾© | ä¸Šã‹ã‚‰é †ã«ãƒãƒƒãƒãƒ³ã‚°ã•ã‚Œã‚‹ |
| `pathType: Prefix` | å‰æ–¹ä¸€è‡´ã€‚`/app` ã¯ `/app/users` ã«ã‚‚ãƒãƒƒãƒ |
| å®šç¾©ã•ã‚Œã¦ã„ãªã„ãƒ‘ã‚¹ | Ingress Controller ãŒ 404 ã‚’è¿”ã™ï¼ˆnginx ã«å±Šã‹ãªã„ï¼‰ |

### Ingress ã‚’é©ç”¨

```bash
k apply -f multi-path-ingress.yaml
```

### /app ã¨ /web ç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ

å‹•ä½œç¢ºèªã®ãŸã‚ã€nginx ã« `/app` ã¨ `/web` ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆã—ã¾ã™ã€‚

ReplicaSet ã§ Pod ãŒ 3 ã¤ã‚ã‚‹ãŸã‚ã€**å…¨ã¦ã® Pod** ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# å…¨ã¦ã® Pod ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
for pod in $(k get pod -n dev -l app=nginxserver -o jsonpath='{.items[*].metadata.name}'); do
  echo "Creating files in $pod"
  k exec -n dev $pod -- mkdir -p /usr/share/nginx/html/app
  k exec -n dev $pod -- sh -c 'echo "<h1>Hello from /app</h1>" > /usr/share/nginx/html/app/index.html'
  k exec -n dev $pod -- mkdir -p /usr/share/nginx/html/web
  k exec -n dev $pod -- sh -c 'echo "<h1>Hello from /web</h1>" > /usr/share/nginx/html/web/index.html'
done
```

:::message
1 ã¤ã® Pod ã«ã ã‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚¹ã«ã‚ˆã‚Šä»–ã® Pod ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚ŒãŸéš›ã« 404 ã«ãªã‚Šã¾ã™ã€‚
:::

### å‹•ä½œç¢ºèª

```bash
# /app ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆIngress â†’ nginx ã«åˆ°é”ï¼‰
curl http://localhost:80/app/
```

```html
<h1>Hello from /app</h1>
```

```bash
# /web ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆIngress â†’ nginx ã«åˆ°é”ï¼‰
curl http://localhost:80/web/
```

```html
<h1>Hello from /web</h1>
```

```bash
# /hoge ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆIngress ã«ãƒ«ãƒ¼ãƒ«ãŒãªã„ã®ã§ 404ï¼‰
curl --head http://localhost:80/hoge
```

```
HTTP/1.1 404 Not Found
...
```

| ãƒ‘ã‚¹ | çµæœ | ç†ç”± |
|------|------|------|
| `/app/` | `200 OK` | Ingress â†’ nginx ã«åˆ°é”ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ã‚Š |
| `/web/` | `200 OK` | Ingress â†’ nginx ã«åˆ°é”ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚ã‚Š |
| `/hoge` | `404 Not Found` | Ingress ã«ãƒ«ãƒ¼ãƒ«ãŒãªãã€nginx ã¾ã§å±Šã‹ãªã„ |

### ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ãƒ‘ã‚¹ã ã‘ã§ãªãã€ãƒ›ã‚¹ãƒˆåã§ã‚‚æŒ¯ã‚Šåˆ†ã‘ã§ãã¾ã™ã€‚

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: host-based-ingress
  namespace: dev
spec:
  ingressClassName: nginx
  rules:
    # api.example.com ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    - host: api.example.com            # Host ãƒ˜ãƒƒãƒ€ãƒ¼ã§ãƒãƒƒãƒ
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-service
                port:
                  name: http
    # web.example.com ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    - host: web.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web-service
                port:
                  name: http
```

**ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä¾‹:**

| ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | ãƒãƒƒãƒã™ã‚‹ãƒ«ãƒ¼ãƒ« | è»¢é€å…ˆ Service |
|-----------|-----------------|----------------|
| `GET /app/users` | `path: /app` | `nginxserver-service` |
| `GET /web/index.html` | `path: /web` | `nginxserver-service` |
| `GET /other` | ãªã— | Ingress Controller ãŒ 404 |
| `api.example.com/` | `host: api.example.com` | `api-service` |

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

k8s ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```bash
k delete -f multi-path-ingress.yaml
k delete -f nginxserver-service.yaml
k delete -f nginxserver-replicaset.yaml
```

Ingress Controller ã‚‚å‰Šé™¤ã™ã‚‹å ´åˆ:

```bash
k delete -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.0/deploy/static/provider/kind/deploy.yaml
```

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã”ã¨å‰Šé™¤ã™ã‚‹å ´åˆ:

```bash
kind delete cluster
```

## ã¾ã¨ã‚

### Service ã¨ã®é–¢ä¿‚

| æ¦‚å¿µ | å½¹å‰² |
|------|------|
| **ClusterIP** | Ingress ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ç”¨ï¼ˆå¤–éƒ¨å…¬é–‹ä¸è¦ï¼‰ |
| **NodePort** | Ingress Controller ãŒä½¿ç”¨ï¼ˆkind ã®å ´åˆï¼‰ |
| **LoadBalancer** | Ingress ãŒä»£æ›¿æ‰‹æ®µã¨ãªã‚‹ |
| **Ingress** | L7 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§è¤‡æ•° Service ã‚’ 1 ã¤ã®å…¥å£ã§å…¬é–‹ |

### Ingress ã®ãƒ¡ãƒªãƒƒãƒˆ

- **ã‚³ã‚¹ãƒˆå‰Šæ¸›**: è¤‡æ•° Service ã‚’ 1 ã¤ã® LB ã§å…¬é–‹
- **ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: `/api` â†’ Service Aã€`/web` â†’ Service B
- **ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: `api.example.com` â†’ Service A
- **SSL çµ‚ç«¯**: Ingress ã§ä¸€å…ƒç®¡ç†

### æœ¬è¨˜äº‹ã§å­¦ã‚“ã ã“ã¨

- Ingress Controller ã¨ Ingress ãƒªã‚½ãƒ¼ã‚¹ã®é•ã„
- kind ã§ã® Ingress ç’°å¢ƒæ§‹ç¯‰ï¼ˆextraPortMappingsï¼‰
- ClusterIP Service ã‚’ Ingress çµŒç”±ã§å¤–éƒ¨å…¬é–‹ã™ã‚‹æ–¹æ³•
- pathTypeï¼ˆExact / Prefixï¼‰ã®ä½¿ã„åˆ†ã‘

## å‚è€ƒè³‡æ–™

- [Ingress | Kubernetes](https://kubernetes.io/docs/concepts/services-networking/ingress/)
- [NGINX Ingress Controller](https://kubernetes.github.io/ingress-nginx/)
- [kind - Ingress](https://kind.sigs.k8s.io/docs/user/ingress/)
