---
title: "Terragruntå…¥é–€ï¼šå…¬å¼Quickstartã‚’å®Ÿè·µã—ã¦ã¿ãŸ"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

Terragruntã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹Quickstartãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰é€²ã‚ã¦ã¿ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã€Terragruntã®åŸºæœ¬çš„ãªæ¦‚å¿µã‹ã‚‰ä¾å­˜é–¢ä¿‚ç®¡ç†ã¾ã§ã€æ®µéšçš„ã«å­¦ã‚“ã å†…å®¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## Terragruntã¨ã¯

Terragruntã¯Terraform/OpenTofuã®ãƒ©ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡Œã‚’è§£æ±ºã—ã¾ã™ï¼š

- **DRYï¼ˆDon't Repeat Yourselfï¼‰**: è¤‡æ•°ç’°å¢ƒã§ã®è¨­å®šã®é‡è¤‡ã‚’æ’é™¤
- **ä¾å­˜é–¢ä¿‚ç®¡ç†**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ã‚’è‡ªå‹•çš„ã«è§£æ±º
- **ä¸€æ‹¬æ“ä½œ**: è¤‡æ•°ã®Terraformãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¸€åº¦ã«æ“ä½œ

## å‰ææ¡ä»¶

- Terraform ã¾ãŸã¯ OpenTofu ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- Terragrunt ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- Unixç³»OSï¼ˆmacOS, Linuxç­‰ï¼‰

## 1. æœ€åˆã®Terragruntãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

### åŸºæœ¬æ§‹æˆ

ã¾ãšã€`foo`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚·ãƒ³ãƒ—ãƒ«ãªTerraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
foo/
â”œâ”€â”€ main.tf
â””â”€â”€ terragrunt.hcl
```

**foo/main.tf**
```hcl
variable "content" {}

resource "local_file" "file" {
  content  = var.content
  filename = "${path.module}/hi.txt"
}
```

**foo/terragrunt.hcl**
```hcl
inputs = {
  content = "Hello from foo, Terragrunt!"
}
```

### å®Ÿè¡Œ

```bash
cd foo
terragrunt apply
```

Terragruntã‚’ä½¿ã†åˆ©ç‚¹ï¼š
- `terraform init` ã‚’è‡ªå‹•å®Ÿè¡Œï¼ˆAuto-initæ©Ÿèƒ½ï¼‰
- `inputs`ãƒ–ãƒ­ãƒƒã‚¯ã§å¤‰æ•°ã‚’å®£è¨€çš„ã«ç®¡ç†ï¼ˆ`-var`ãƒ•ãƒ©ã‚°ä¸è¦ï¼‰

## 2. ãƒ¦ãƒ‹ãƒƒãƒˆã®è¿½åŠ ã¨å…±æœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

### ãƒ¦ãƒ‹ãƒƒãƒˆã¨ã¯

Terragruntã«ãŠã‘ã‚‹ã€Œãƒ¦ãƒ‹ãƒƒãƒˆã€ã¯ã€`terragrunt.hcl`ã‚’å«ã‚€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã“ã¨ã§ã€å˜ä¸€ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’è¡¨ã—ã¾ã™ã€‚

### å…±æœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`foo`ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦`bar`ã‚’ä½œæˆã—ã€å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’`shared`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚

```
quickstart/
â”œâ”€â”€ foo/
â”‚   â”œâ”€â”€ main.tf
â”‚   â””â”€â”€ terragrunt.hcl
â”œâ”€â”€ bar/
â”‚   â”œâ”€â”€ main.tf
â”‚   â””â”€â”€ terragrunt.hcl
â””â”€â”€ shared/
    â””â”€â”€ main.tf
```

**shared/main.tf**
```hcl
variable "content" {}

resource "local_file" "file" {
  content  = var.content
  filename = "${path.module}/hi.txt"
}
```

**foo/main.tf**
```hcl
variable "content" {}

module "shared" {
  source  = "../shared"
  content = var.content
}
```

ã“ã®æ§‹æˆã§ã‚‚å‹•ä½œã—ã¾ã™ãŒã€`foo/main.tf`ã¨`bar/main.tf`ã«é‡è¤‡ãŒã‚ã‚Šã¾ã™ã€‚

## 3. DRYæ§‹æˆã¸ã®é€²åŒ–

### terraformãƒ–ãƒ­ãƒƒã‚¯ã§ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š

å„ãƒ¦ãƒ‹ãƒƒãƒˆã®`main.tf`ã‚’å‰Šé™¤ã—ã€`terragrunt.hcl`ã®`terraform`ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
quickstart/
â”œâ”€â”€ foo/
â”‚   â””â”€â”€ terragrunt.hcl
â”œâ”€â”€ bar/
â”‚   â””â”€â”€ terragrunt.hcl
â””â”€â”€ shared/
    â””â”€â”€ main.tf
```

**foo/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

inputs = {
  content = "Hello from foo, Terragrunt!"
}
```

**bar/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

inputs = {
  content = "Hello from bar, Terragrunt!"
}
```

### ãƒã‚¤ãƒ³ãƒˆ

- Terraformã‚³ãƒ¼ãƒ‰ã¯`shared/`ã«ã®ã¿å­˜åœ¨
- å„ç’°å¢ƒã®å·®åˆ†ã¯`terragrunt.hcl`ã®`inputs`ã§ç®¡ç†
- `.tf`ãƒ•ã‚¡ã‚¤ãƒ«ã®é‡è¤‡ãŒå®Œå…¨ã«æ’é™¤ã•ã‚Œã‚‹

## 4. ã‚¹ã‚¿ãƒƒã‚¯ç®¡ç†ï¼ˆè¤‡æ•°ãƒ¦ãƒ‹ãƒƒãƒˆã®ä¸€æ‹¬æ“ä½œï¼‰

### ã‚¹ã‚¿ãƒƒã‚¯ã¨ã¯

ã€Œã‚¹ã‚¿ãƒƒã‚¯ã€ã¯ã€ä¸€ç·’ã«ç®¡ç†ã•ã‚Œã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆã®é›†åˆã§ã™ã€‚dev/staging/prodç’°å¢ƒã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’æŒ‡ã—ã¾ã™ã€‚

### run-allã‚³ãƒãƒ³ãƒ‰

è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è¤‡æ•°ãƒ¦ãƒ‹ãƒƒãƒˆã‚’ä¸€æ‹¬æ“ä½œã§ãã¾ã™ã€‚

```bash
cd quickstart
terragrunt run-all plan   # å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã§plan
terragrunt run-all apply  # å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã§apply
```

å®Ÿè¡Œä¾‹ï¼š
```
The stack at . will be processed in the following order for command apply:
Group 1
- Module ./bar
- Module ./foo

Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n)
```

Terragruntã¯ä¸¦åˆ—å®Ÿè¡Œã—ã€å„ãƒ¦ãƒ‹ãƒƒãƒˆã®å‡ºåŠ›ã‚’åŒºåˆ¥ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

## 5. DAGï¼ˆä¾å­˜é–¢ä¿‚ï¼‰ç®¡ç†

### ä¾å­˜é–¢ä¿‚ã®è¨­å®š

`bar`ãŒ`foo`ã®å‡ºåŠ›ã«ä¾å­˜ã™ã‚‹å ´åˆã‚’è€ƒãˆã¾ã™ã€‚

**shared/output.tfï¼ˆè¿½åŠ ï¼‰**
```hcl
output "content" {
  value = local_file.file.content
}
```

**bar/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

dependency "foo" {
  config_path = "../foo"
}

inputs = {
  content = "Foo content: ${dependency.foo.outputs.content}"
}
```

### DAGã«ã‚ˆã‚‹å®Ÿè¡Œé †åºã®è‡ªå‹•æ±ºå®š

`run-all`å®Ÿè¡Œæ™‚ã€Terragruntã¯ä¾å­˜é–¢ä¿‚ã‚’åˆ†æã—ã¦DAGï¼ˆæœ‰å‘éå·¡å›ã‚°ãƒ©ãƒ•ï¼‰ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```
Group 1: foo  ï¼ˆå…ˆã«å®Ÿè¡Œï¼‰
Group 2: bar  ï¼ˆfooã®å¾Œã«å®Ÿè¡Œï¼‰
```

ã“ã‚Œã«ã‚ˆã‚Šã€`bar`ã¯`foo`ã®å‡ºåŠ›ã‚’ç¢ºå®Ÿã«å‚ç…§ã§ãã¾ã™ã€‚

## 6. mock_outputsï¼ˆä¾å­˜å…ˆã®outputãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

### å•é¡Œ

`foo`ãŒã¾ã applyã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã§`bar`ã‚’planã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```
../foo/terragrunt.hcl is a dependency of ./terragrunt.hcl but detected no outputs.
Either the target module has not been applied yet, or the module has no outputs.
```

### è§£æ±ºï¼šmock_outputs

`mock_outputs`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ä¾å­˜å…ˆã®outputãŒãªã„å ´åˆã§ã‚‚planãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

**bar/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

dependency "foo" {
  config_path = "../foo"
  mock_outputs = {
    content = "Mocked content from foo"
  }
}

inputs = {
  content = "Foo content: ${dependency.foo.outputs.content}"
}
```

### mock_outputsã®å‹•ä½œ

| ãƒ•ã‚§ãƒ¼ã‚º | fooã®state | barã§ä½¿ã‚ã‚Œã‚‹å€¤ |
|---------|-----------|----------------|
| planï¼ˆfooæœªapplyï¼‰ | ãªã— | mock_outputsã®å€¤ |
| apply | ã‚ã‚Š | fooã®å®Ÿéš›ã®output |
| planï¼ˆfoo applyæ¸ˆã¿ï¼‰ | ã‚ã‚Š | fooã®å®Ÿéš›ã®output |

`run-all apply`ã®å ´åˆã€DAGã«å¾“ã£ã¦`foo`ãŒå…ˆã«applyã•ã‚Œã‚‹ãŸã‚ã€`bar`ã®applyæ™‚ã«ã¯å®Ÿéš›ã®å€¤ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

## 7. mock_outputs_allowed_terraform_commands

### ç”¨é€”

CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãªã©ã§ã€Œplanæ™‚ã¯mockã§OKã ãŒã€applyæ™‚ã«ä¾å­˜å…ˆãŒæœªapplyã®çŠ¶æ…‹ã¯å±é™ºãªã®ã§ç¦æ­¢ã—ãŸã„ã€å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚

**bar/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

dependency "foo" {
  config_path = "../foo"
  mock_outputs = {
    content = "Mocked content from foo"
  }
  mock_outputs_allowed_terraform_commands = ["plan"]  # planã®ã¿è¨±å¯
}

inputs = {
  content = "Foo content: ${dependency.foo.outputs.content}"
}
```

### å‹•ä½œç¢ºèª

fooã®stateãŒãªã„çŠ¶æ…‹ã§ï¼š

| ã‚³ãƒãƒ³ãƒ‰ | mockä½¿ç”¨ | çµæœ |
|---------|---------|------|
| `terragrunt plan` | è¨±å¯ | æˆåŠŸï¼ˆmockå€¤ä½¿ç”¨ï¼‰ |
| `terragrunt apply` | ç¦æ­¢ | ã‚¨ãƒ©ãƒ¼ |
| `terragrunt run-all apply` | ä¸è¦ | æˆåŠŸï¼ˆDAGé †ã§å®Ÿè¡Œï¼‰ |

## 8. .terragrunt-cache ã¨ path.module

### ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹å ´æ‰€

`${path.module}/hi.txt`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯`.terragrunt-cache`å†…ã«ä½œæˆã•ã‚Œã¾ã™ã€‚

```
foo/.terragrunt-cache/xxxxx/yyyyy/hi.txt  â† ã“ã“ã«ä½œæˆã•ã‚Œã‚‹
```

### ç†ç”±

Terragruntã®å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼š
1. `foo/`ã§`terragrunt apply`ã‚’å®Ÿè¡Œ
2. `shared/`ã®ã‚³ãƒ¼ãƒ‰ã‚’`foo/.terragrunt-cache/xxxxx/yyyyy/`ã«ã‚³ãƒ”ãƒ¼
3. ãã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§Terraformã‚’å®Ÿè¡Œ

ã“ã®ãŸã‚ã€`path.module`ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡ã—ã¾ã™ã€‚

### get_terragrunt_dir()ã§è§£æ±º

`terragrunt.hcl`ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã„å ´åˆã¯ã€`get_terragrunt_dir()`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**shared/main.tf**
```hcl
variable "content" {}
variable "output_dir" {}

resource "local_file" "file" {
  content  = var.content
  filename = "${var.output_dir}/hi.txt"
}
```

**foo/terragrunt.hcl**
```hcl
terraform {
  source = "../shared"
}

inputs = {
  content    = "Hello from foo, Terragrunt!"
  output_dir = get_terragrunt_dir()  # "/path/to/foo" ãŒæ¸¡ã•ã‚Œã‚‹
}
```

### é–¢é€£ã™ã‚‹çµ„ã¿è¾¼ã¿é–¢æ•°

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `get_terragrunt_dir()` | `terragrunt.hcl`ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ |
| `get_parent_terragrunt_dir()` | è¦ªã®`terragrunt.hcl`ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ |
| `get_repo_root()` | Gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ |

## ã¾ã¨ã‚

Terragruntã‚’ä½¿ã†ã“ã¨ã§ï¼š

1. **DRYæ§‹æˆ**: `terraform { source = "..." }`ã§å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‚ç…§ã—ã€`inputs`ã§ç’°å¢ƒå·®åˆ†ã‚’ç®¡ç†
2. **ã‚¹ã‚¿ãƒƒã‚¯ç®¡ç†**: `run-all`ã§è¤‡æ•°ãƒ¦ãƒ‹ãƒƒãƒˆã‚’ä¸€æ‹¬æ“ä½œ
3. **DAG**: `dependency`ãƒ–ãƒ­ãƒƒã‚¯ã§ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã—ã€å®Ÿè¡Œé †åºã‚’è‡ªå‹•æ±ºå®š
4. **mock_outputs**: ä¾å­˜å…ˆãŒæœªapplyã§ã‚‚planã‚’å®Ÿè¡Œå¯èƒ½
5. **mock_outputs_allowed_terraform_commands**: mockã®ä½¿ç”¨ã‚’ç‰¹å®šã‚³ãƒãƒ³ãƒ‰ã«åˆ¶é™

Terragruntã¯ã€Terraform/OpenTofuãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã•ã›ã‚‹éš›ã®è¤‡é›‘ã•ã‚’å¤§å¹…ã«è»½æ¸›ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

## å‚è€ƒ

- [Terragruntå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Quick Start](https://terragrunt.gruntwork.io/docs/getting-started/quick-start/)
- [Terragruntå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Built-in Functions](https://terragrunt.gruntwork.io/docs/reference/built-in-functions/)
