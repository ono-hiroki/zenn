---
title: ""
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# Terragrunt + SOPS ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å®‰å…¨ã« Git ç®¡ç†ã™ã‚‹

## èª²é¡Œ

IaC ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã©ã†ç®¡ç†ã™ã‚‹ã‹ï¼Ÿ

- `.tfvars` ã«å¹³æ–‡ã§æ›¸ã â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
- ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™ â†’ CI/CD ãŒè¤‡é›‘ã«
- å¤–éƒ¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ« â†’ å­¦ç¿’ã‚³ã‚¹ãƒˆ

## è§£æ±ºç­–

**SOPS** ã§æš—å·åŒ–ã—ã¦ Git ç®¡ç†ã—ã€**Terragrunt** ã® `sops_decrypt_file` ã§å¾©å·ã™ã‚‹ã€‚

```
secrets.yaml (æš—å·åŒ–æ¸ˆã¿)
        â”‚
        â–¼ Terragrunt: sops_decrypt_file()
        â”‚
        â–¼ AWS KMS ã§å¾©å·
        â”‚
    Terraform ã«æ¸¡ã™
```

## æœ€å°æ§‹æˆ

```
live/
â”œâ”€â”€ .sops.yaml              # SOPS è¨­å®š
â””â”€â”€ dev/
    â””â”€â”€ secrets/
        â”œâ”€â”€ terragrunt.hcl  # sops_decrypt_file() ã‚’ä½¿ç”¨
        â””â”€â”€ secrets.yaml    # æš—å·åŒ–æ¸ˆã¿
```

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. SOPS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
brew install sops
```

### 2. .sops.yaml ä½œæˆ

```yaml
creation_rules:
  - path_regex: \.yaml$
    kms: arn:aws:kms:ap-northeast-1:ACCOUNT_ID:alias/YOUR_KEY
```

### 3. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ & æš—å·åŒ–

```yaml
# secrets.yaml
db_password: "secret123"
api_key: "key456"
```

```bash
sops --encrypt --in-place secrets.yaml
```

### 4. Terragrunt ã§ä½¿ç”¨

```hcl
locals {
  secrets = yamldecode(sops_decrypt_file("${get_terragrunt_dir()}/secrets.yaml"))
}

inputs = {
  db_password = local.secrets.db_password
  api_key     = local.secrets.api_key
}
```

## æ—¥å¸¸æ“ä½œ

```bash
# ç·¨é›†ï¼ˆå¾©å·â†’ç·¨é›†â†’å†æš—å·åŒ–ãŒè‡ªå‹•ï¼‰
sops secrets.yaml

# ç¢ºèª
sops --decrypt secrets.yaml
```

## ãƒã‚¤ãƒ³ãƒˆ

- **ã‚­ãƒ¼åã¯å¹³æ–‡**ã€å€¤ã ã‘æš—å·åŒ– â†’ diff ãŒè¦‹ã‚„ã™ã„
- **Git ã§å±¥æ­´ç®¡ç†**ã§ãã‚‹
- **Terragrunt ãƒã‚¤ãƒ†ã‚£ãƒ–å¯¾å¿œ**ã§è¿½åŠ ãƒ„ãƒ¼ãƒ«ä¸è¦
- ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ KMS ã‚­ãƒ¼ã§**æ¨©é™åˆ†é›¢**å¯èƒ½
