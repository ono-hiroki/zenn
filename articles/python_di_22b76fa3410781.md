---
title: "Pythonã§DIã™ã‚‹ï¼ˆDependency Injectorï¼‰"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python"]
published: true
---

[dependency_injector](https://python-dependency-injector.ets-labs.org/) ã¯ Python å‘ã‘ã®ä¾å­˜æ€§æ³¨å…¥ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

# åŸºæœ¬çš„ãªä½¿ã„æ–¹

Dependency Injector ã‚’åˆ©ç”¨ã—ã¦ä¾å­˜æ€§æ³¨å…¥ã‚’è¡Œã†åŸºæœ¬çš„ãªæµã‚Œã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿç¾ã—ã¾ã™ã€‚

1. ã‚µãƒ¼ãƒ“ã‚¹ã®å®šç¾©
   ã¾ãšã€æŠ½è±¡ã‚¯ãƒ©ã‚¹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’å®šç¾©ã—ã€ãã®å®Ÿè£…ã¨ãªã‚‹å…·ä½“çš„ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
   ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ãŒå‘¼ã³å‡ºã—å…ƒã‹ã‚‰ç‹¬ç«‹ã—ã€å¾Œã‹ã‚‰ç°¡å˜ã«å…¥ã‚Œæ›¿ãˆã‚„ãƒ†ã‚¹ãƒˆãŒè¡Œãˆã‚‹è¨­è¨ˆã«ãªã‚Šã¾ã™ã€‚
2. ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š
   æ¬¡ã«ã€dependency_injector ã® containers.DeclarativeContainer ã‚’ç¶™æ‰¿ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒ©ã‚¹ï¼ˆä¾‹: ApplicationContainerï¼‰ã‚’å®šç¾©ã—ã¾ã™ã€‚
   ã“ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã€è¨­å®šå€¤ï¼ˆconfigï¼‰ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆä¾‹: providers.Factoryï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚
   ã“ã“ã§å®šç¾©ã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é€šã˜ã¦ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ãªä¾å­˜æ€§ã¨ã¨ã‚‚ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
3. ä¾å­˜æ€§ã®æ³¨å…¥
   ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆä¾‹: main.pyï¼‰ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”Ÿæˆã—ã€è¨­å®šå€¤ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
   ãã®å¾Œã€ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚
   ã“ã‚Œã«ã‚ˆã‚Šã€main.py ã¯ã‚µãƒ¼ãƒ“ã‚¹ã®å…·ä½“çš„ãªå®Ÿè£…ã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãã€ã‚³ãƒ³ãƒ†ãƒŠçµŒç”±ã§å¿…è¦ãªæ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
4. è‡ªå‹•ä¾å­˜æ€§æ³¨å…¥ï¼ˆ@inject ã®åˆ©ç”¨ï¼‰
   ã•ã‚‰ã«ã€@inject ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€é–¢æ•°ã®å¼•æ•°ã«ä¾å­˜æ€§ã‚’è‡ªå‹•çš„ã«æ³¨å…¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€Dependency Injector ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ä¾å­˜æ€§ã®ç®¡ç†ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µæ€§ã‚„ãƒ†ã‚¹ãƒˆã®ã—ã‚„ã™ã•ãŒå‘ä¸Šã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å‚è€ƒã«ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè£…æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```plaintext
.
â”œâ”€â”€ containers.py
â”œâ”€â”€ main.py
â””â”€â”€ services.py
```

Laravelã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç”¨ã„ã¦ä¾å­˜æ€§ã‚’æ³¨å…¥ã—ã¾ã™ãŒã€dependency_injectorã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’é€šã˜ã¦ä¾å­˜æ€§æ³¨å…¥ã‚’å®Ÿç¾ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€main.pyã¯ExampleServiceã®å…·ä½“çš„ãªå®Ÿè£…ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ã“ã¨ãªãã€ApplicationContainerã‹ã‚‰ExampleServiceã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```mermaid
classDiagram
    class IExampleService {
        <<interface>>
        +do_something() str
    }
    class ExampleService {
        -greeting: str
        +do_something() str
    }
    class ApplicationContainer {
        +config: Configuration
        +example_service_provider() IExampleService
    }
    class Configuration {
        +greeting: str
    }
    class mainModule {
        <<module>>
        +main()
    }
    
    IExampleService <|-- ExampleService : å®Ÿè£…ã™ã‚‹
    ApplicationContainer --> IExampleService : ä½œæˆã™ã‚‹
    ApplicationContainer --> Configuration : ä½¿ã†
    mainModule --> ApplicationContainer : ä½¿ã†
```

## 1. ã‚µãƒ¼ãƒ“ã‚¹ã®å®šç¾©

ã¾ãšã¯ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨å®Ÿè£…ã‚’å®šç¾©ã—ã¾ã™ã€‚

```Python
from abc import ABC, abstractmethod

class IExampleService(ABC):
    @abstractmethod
    def do_something(self) -> str:
        pass

class ExampleService(IExampleService):
    def __init__(self, greeting: str):
        self.greeting = greeting

    def do_something(self) -> str:
        return f"{self.greeting}, Dependency Injection!"
```

## 2. ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©

ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚

```Python
from dependency_injector import containers, providers
from services import ExampleService


class ApplicationContainer(containers.DeclarativeContainer):
    config = providers.Configuration()


    example_service_provider = providers.Factory(
        ExampleService,
        greeting=config.greeting,
    )
```

## 3. ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ãŸä¾å­˜æ€§ã®æ³¨å…¥

ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¦ä¾å­˜æ€§ã‚’æ³¨å…¥ã—ã¾ã™ã€‚

```Python
from containers import ApplicationContainer
from services import IExampleService


def main():
    container = ApplicationContainer()
    container.config.from_dict({"greeting": "Hello"})

    example_service: IExampleService = container.example_service_provider()

    print(example_service.do_something())  # "Hello, Dependency Injection!"


if __name__ == "__main__":
    main()
```

## 4. @injectã§ä¾å­˜æ€§ã‚’æ³¨å…¥ã™ã‚‹

dependency_injector ã¯è‡ªå‹•ã§ä¾å­˜æ€§ã‚’æ³¨å…¥ã™ã‚‹ä»•çµ„ã¿ã‚‚æä¾›ã—ã¦ã„ã¾ã™ã€‚

```Python
from dependency_injector.wiring import inject, Provide
from containers import ApplicationContainer
from services import ExampleService


@inject
def run_service(
        service: ExampleService = Provide[ApplicationContainer.example_service_provider]
):
    print(service.do_something())


if __name__ == "__main__":
    container = ApplicationContainer()
    container.config.from_dict({"greeting": "Hello"})
    container.wire(modules=[__name__])

run_service()
```

## å®Ÿè¡Œã—ã¦ã¿ã‚‹

```bash
$ python main.py
Hello, Dependency Injection!
```

# ã¾ã¨ã‚

fastapiã®ä¾å­˜æ³¨å…¥ã ã¨ã€ä¾å­˜æ€§ã‚’æ³¨å…¥ã™ã‚‹ãŸã‚ã«é–¢æ•°ã®å¼•æ•°ã«ä¾å­˜æ€§ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€dependency_injector ã‚’ä½¿ã†ã¨ã€ä¾å­˜æ€§ã‚’æ³¨å…¥ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦ä¾å­˜æ€§ã‚’æ³¨å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
