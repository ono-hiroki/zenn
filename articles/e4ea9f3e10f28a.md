---
title: "FastAPI Ã— OpenAI ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§â€œãƒ”ãƒ­ãƒ”ãƒ­â€å‡ºåŠ›ã™ã‚‹APIã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## ã¯ã˜ã‚ã«

ã€Œãƒ”ãƒ­ãƒ”ãƒ­ã€ã¨ä¸€æ–‡å­—ãšã¤æµã‚Œã‚‹ã‚ˆã†ãª UI ã‚’å®Ÿç¾ã—ãŸã„ã¨ãã€OpenAI API ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã›ã¾ã™ã€‚FastAPI ãªã‚‰ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã§ãã‚‹ã‚‰ã—ã„ã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

## ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ç°¡å˜ãªå®Ÿè£…ä¾‹ã§ã¯ä½¿ã£ã¦ã„ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```plain text
# requirements.txt
fastapi
uvicorn[standard]
dependency-injector
pytest
httpx
openai
```

OpenAI API ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€API ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚
ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦`OPENAI_API_KEY` ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

```.dotenv
OPENAI_API_KEY=sk-â€¦
```

3. ã‹ã‚“ãŸã‚“ãªå®Ÿè£…ä¾‹

ã¾ãšã¯ã€FastAPI ã‚’ä½¿ã£ã¦ OpenAI API ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹ç°¡å˜ãªå®Ÿè£…ä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
OpenAIã® stremã‚’true ã«ã—ã¦ã€FastAPI ã® StreamingResponse ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
from fastapi import FastAPI, Request
from fastapi.responses import StreamingResponse
from openai import OpenAI

client = OpenAI()
app = FastAPI()

def openai_stream_generator(messages: list[dict[str, str]]):
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        stream=True,
        messages=messages,
    )
    for chunk in response:
        delta = chunk.choices[0].delta
        if hasattr(delta, "content") and delta.content:
            yield f"data: {delta.content}\n\n"

    yield "event: done\ndata: [DONE]\n\n"

@app.post("/v1/chat/stream", status_code=200)
async def chat_stream(request: Request):
    body = await request.json()
    messages = body.get("messages", [])

    generator = openai_stream_generator(messages)
    return StreamingResponse(generator, media_type="text/event-stream")
```

## å‹•ä½œç¢ºèªã™ã‚‹ï¼‘ï¼ˆcurl ã§ç¢ºèªï¼‰

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€OpenAI API ã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
curl -N \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"system","content":"You are a helpful assistant."},{"role":"user","content":"ã‚„ã£ã»"}]}' \
  http://127.0.0.1:8000/v1/chat/stream
  
data: ã‚„

data: ã£

data: ã»

data: ï¼

...

event: done
data: [DONE]
```

## å‹•ä½œç¢ºèªã™ã‚‹ï¼’ï¼ˆã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦ãã‚Œã£ã½ãå‡ºåŠ›ã™ã‚‹ï¼‰

ä¸‹è¨˜ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€AI ã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```shell
#!/usr/bin/env bash

URL="http://127.0.0.1:8000/v1/chat/stream"
PAYLOAD='{"messages":[{"role":"system","content":"You are a helpful assistant."},{"role":"user","content":"ã‚„ã£ã»"}]}'

curl -sN \
  -H "Content-Type: application/json" \
  -d "${PAYLOAD}" \
  "${URL}" |
while IFS= read -r line; do
  if [[ $line == data:* ]]; then
    printf '%s' "${line#data: }"
  elif [[ $line == event:\ done ]]; then
    break
  fi
done

printf '\n'
```

## ã¾ã¨ã‚

FastAPI ã‚’ä½¿ã£ã¦ OpenAI API ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚
ã„ã¾ã•ã‚‰æ„Ÿã‚‚ã‚ã‚Šã¾ã™ãŒã€æ¬¡ã¯RAGã§ã‚‚ã‚„ã£ã¦ã¿ã‚ˆã†ã‹ãªã¨æ€ã„ã¾ã™ã€‚

## ãŠã¾ã‘

FastAPIã«ã‚ã¾ã‚Šæ…£ã‚Œã¦ã„ãªã„ã®ã§ã€ç·´ç¿’ã§å°‘ã—æ•´ç†ã—ãŸæ§‹æˆã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸ ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ã—ã¦ã„ã¾ã™ã€‚ ç´°ã‹ã„ã¨ã“ã‚ã¯è‰²ã€…ã‚ã‚Šãã†ã§ã™ãŒã€ãã‚Œã£ã½ãã§ããã†ã§ã™ã€‚
ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯ [githubã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/ono-hiroki/streaming-chat-api)ã«ã‚ã‚Šã¾ã™ã€‚

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã—ã¾ã™ã€‚

```
src/app/
â”œâ”€â”€ containers.py                 # DI ã‚³ãƒ³ãƒ†ãƒŠå®šç¾©
â”œâ”€â”€ main.py                       # FastAPI ã‚¢ãƒ—ãƒªèµ·ç‚¹
â”œâ”€â”€ domain/adapters/
â”‚   â””â”€â”€ openai_client_interface.py  # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ï¼ˆpythonã£ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç„¡ã„ï¼Ÿï¼‰
â”œâ”€â”€ infrastructure/adapters/
â”‚   â””â”€â”€ openai_client.py           # OpenAI SDK ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã—ã¦ã‚‹
â”œâ”€â”€ use_cases/
â”‚   â””â”€â”€ chat_stream_action.py      # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…
â””â”€â”€ routes/v1/
    â””â”€â”€ root.py                    # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```

### 2. DI ã‚³ãƒ³ãƒ†ãƒŠå®šç¾© (`src/app/containers.py`)

dependency_injector ã‚’ä½¿ã£ã¦ DI ã‚³ãƒ³ãƒ†ãƒŠã‚’å®šç¾©ã—ã¾ã™ã€‚

```python
from dependency_injector import containers, providers
from app.infrastructure.adapters.openai_client import OpenAIClient
from app.use_cases.chat_stream_action import ChatStreamAction
from openai import OpenAI

class ApplicationContainer(containers.DeclarativeContainer):
    openai_client = providers.Singleton(OpenAI)
    openai_client_adapter = providers.Singleton(OpenAIClient, client=openai_client)
    chat_stream_action = providers.Factory(ChatStreamAction, openai_client=openai_client_adapter)
```

### 3. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾© (`src/app/domain/adapters/openai_client_interface.py`)

openai_client.py ã§å®Ÿè£…ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
Protocol ã¨ Abstract ã®é•ã„ãŒã‚ˆãåˆ†ã‹ã£ã¦ã„ãªã„ã§ã™ãŒã€ã¨ã‚Šã‚ãˆãš Protocol ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚å¾Œã§èª¿ã¹ã¾ã™ã€‚

```python
from typing import List, Dict, Generator, Protocol

class IOpenAIClient(Protocol):
    def stream_chat(self, messages: List[Dict[str, str]]) -> Generator[str, None, None]:
        """
        OpenAI ã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’ SSE å½¢å¼ã§ yield ã™ã‚‹ã€‚
        """
        ...
```

### 4. SDK ãƒ©ãƒƒãƒ‘ãƒ¼ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å®Ÿè£… (`src/app/infrastructure/adapters/openai_client.py`)

å…ˆã»ã©å®šç¾©ã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
import json
from typing import List, Dict, Generator
from openai import OpenAI

from app.domain.adapters.openai_client_interface import IOpenAIClient


class OpenAIClient(IOpenAIClient):
    def __init__(self, client: OpenAI, model: str = "gpt-4o-mini"):
        self.client = client
        self.model = model

    def stream_chat(self, messages: List[Dict[str, str]]) -> Generator[str, None, None]:
        """
        OpenAI ã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’ SSE å½¢å¼ã§ yield ã™ã‚‹ã€‚
        """
        response = self.client.chat.completions.create(
            model=self.model, stream=True, messages=messages
        )
        for chunk in response:
            delta = chunk.choices[0].delta
            if hasattr(delta, "content") and delta.content:
                yield f"data: {delta.content}\n\n"
        yield "event: done\ndata: [DONE]\n\n"
```

### 5. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ (`src/app/use_cases/chat_stream_action.py`)

ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€OpenAIClient ã‚’ä½¿ã£ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
from typing import List, Dict, Generator
from app.infrastructure.adapters.openai_client import OpenAIClient

class ChatStreamAction:
    def __init__(self, openai_client: OpenAIClient):
        self.openai_client = openai_client

    def execute(self, messages: List[Dict[str, str]]) -> Generator[str, None, None]:
        return self.openai_client.stream_chat(messages)
```

### 6. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (`src/app/routes/v1/root.py`)

FastAPI ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ã¦ã€OpenAI API ã‹ã‚‰ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
# app/routes/v1/root.py
from typing import List, Dict

from fastapi import APIRouter, Depends
from dependency_injector.wiring import inject, Provide

from app.use_cases.chat_stream_action import ChatStreamAction
from app.containers import ApplicationContainer
from fastapi import Request
from fastapi.responses import StreamingResponse

router = APIRouter()

@router.post("/chat/stream", status_code=200)
@inject
async def chat_stream(
        request: Request,
        action: ChatStreamAction = Depends(Provide[ApplicationContainer.chat_stream_action]),
):
    body = await request.json()
    messages: List[Dict[str, str]] = body.get("messages", [])
    generator = action.execute(messages)
    return StreamingResponse(generator, media_type="text/event-stream")
```

### 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®main.py (`src/app/main.py`)

FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```python
# app/main.py
from fastapi import FastAPI
from app.containers import ApplicationContainer
from app.routes.v1.root import router as message_router

def create_app() -> FastAPI:
    container = ApplicationContainer()

    container.wire(
        modules=[
            __name__,
            "app.routes.v1.root",
        ]
    )

    app = FastAPI()
    app.container = container

    app.include_router(message_router, prefix="/v1", tags=["Message"])

    return app

app = create_app()
```

### 8. å‹•ä½œç¢ºèª

å‹•ä½œã¯ç‰¹ã«å¤‰ã‚ã‚‰ãªã„ã®ã§ã€ã•ãã»ã©ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„curlã§ç¢ºèªã§ãã¾ã™ã€‚

```bash
curl -N \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"system","content":"You are a helpful assistant."},{"role":"user","content":"ã‚„ã£ã»"}]}' \
  http://127.0.0.1:8000/v1/chat/stream
  
data: ã‚„

data: ã£

data: ã»

data: ï¼

...

event: done
data: [DONE]
```







